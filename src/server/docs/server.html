<!DOCTYPE html>

<html>
<head>
  <title>server.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Cakefile.html">
                Cakefile.coffee
              </a>
            
              
              <a class="source" href="auth_cookie.html">
                auth_cookie.coffee
              </a>
            
              
              <a class="source" href="scrape.html">
                scrape.coffee
              </a>
            
              
              <a class="source" href="server.html">
                server.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Literary Worlds
Node.JS interchange server
Interchanges data between a client with socket.io and a LambdaMOO server,
over telnet.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Dependancy imports</p>
<h6 id="-">#</h6>

            </div>
            
            <div class="content"><div class='highlight'><pre>net = <span class="hljs-built_in">require</span> <span class="hljs-string">'net'</span>
http = <span class="hljs-built_in">require</span> <span class="hljs-string">'http'</span>
socket_io = <span class="hljs-built_in">require</span> <span class="hljs-string">'socket.io'</span>
express = <span class="hljs-built_in">require</span> <span class="hljs-string">'express'</span>
http = <span class="hljs-built_in">require</span> <span class="hljs-string">'http'</span>
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
scrape = <span class="hljs-built_in">require</span> <span class="hljs-string">'./scrape'</span>
auth_cookie = <span class="hljs-built_in">require</span> <span class="hljs-string">'./auth_cookie'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Read config.json, set parameters accordingly</p>
<h6 id="-">#</h6>

            </div>
            
            <div class="content"><div class='highlight'><pre>config = fs.readFileSync(<span class="hljs-string">'./config.json'</span>)
<span class="hljs-keyword">try</span>
  obj = JSON.parse(config)
  server_name = obj.server_name
  socket_port = obj.socket_port
  node_domain = obj.node_domain
  server = obj.server
  telnet_port = obj.telnet_port
  enCore_port = obj.enCore_port
  enCore_init = obj.enCore_init
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'server configuration:\n---------------------'</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tserver_name: '</span> + server_name
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tsocket_port: '</span> + socket_port
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tnode_domain: '</span> + node_domain
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tserver: '</span> + server
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\ttelnet_port: '</span> + telnet_port
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tenCore_port: '</span> + enCore_port
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'\tenCore_init: '</span> + enCore_init
<span class="hljs-keyword">catch</span> err
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Error reading config.json!'</span>
  process.exit(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Set up express to serve the client and socket.io to listen to the socket_port</p>
<h6 id="-">#</h6>

            </div>
            
            <div class="content"><div class='highlight'><pre>app = express()
io = socket_io.listen(socket_port)
app.use(<span class="hljs-string">'/'</span>, express.static(<span class="hljs-string">'../client/'</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Handle a user session. When telnet data comes in, write it to the user over
the websocket. When the user sends data over the websocket, send it out on
telnet. When the telnet connection sends an URL, scrape the HTML and send it
to the client.</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>When a user connects, and then fires the auth event, call get_auth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>io.sockets.<span class="hljs-literal">on</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(io)</span> =&gt;</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Incoming socket.io connection\n'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>On auth event, kick off getting access code and autologin string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'auth'</span>, <span class="hljs-function"><span class="hljs-params">(authData)</span> =&gt;</span> get_auth(io, authData))
)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Get the client authenticated, we need an autologin string for telnet and an
access code cookie to present to enCore when making requests of it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">get_auth</span> = <span class="hljs-params">(io, authData)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get an access code cookie from enCore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'auth '</span> + authData.user + <span class="hljs-string">":"</span> + authData.passwd
  auth = <span class="hljs-keyword">new</span> auth_cookie(server, enCore_port)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Using that access code, get an autologin string for our user and password</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  auth.get_access_code(authData.user, authData.passwd, <span class="hljs-function"><span class="hljs-params">(access_code)</span> =&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'access code is '</span> + access_code
    <span class="hljs-keyword">if</span> access_code <span class="hljs-keyword">is</span> <span class="hljs-string">"failed"</span>
      io.emit(<span class="hljs-string">"auth_fail"</span>)
    <span class="hljs-keyword">else</span>
      auth.get_autologin_string(access_code, <span class="hljs-function"><span class="hljs-params">(autologin)</span> =&gt;</span>
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">'autologin is '</span> + autologin
        handle_session(io, access_code, autologin)
      )
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>We have access code and autologin string, now handle telnet and HTTP events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">handle_session</span> = <span class="hljs-params">(io, access_code, autologin)</span> =&gt;</span>
  telnet = net.createConnection(telnet_port, server)
  s = <span class="hljs-keyword">new</span> scrape(server, enCore_port, node_domain)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Use our autologin string for the telnet session</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  telnet.write(autologin + <span class="hljs-string">"\r\n"</span>)

  telnet.<span class="hljs-literal">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(telnetData)</span> -&gt;</span>
    io.emit(<span class="hljs-string">'tcp_line'</span>, telnetData)
  ).<span class="hljs-literal">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    io.emit(<span class="hljs-string">'error'</span>)
  ).<span class="hljs-literal">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    io.emit(<span class="hljs-string">'disconnect'</span>)
  )

  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'io_line'</span>, <span class="hljs-function"><span class="hljs-params">(socketData)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> telnet?
      <span class="hljs-keyword">if</span> telnet.writable
        telnet.write(socketData + <span class="hljs-string">"\r\n"</span>)
      <span class="hljs-keyword">else</span>
        io.emit(<span class="hljs-string">'error'</span>, <span class="hljs-string">'timeout'</span>)
  ).<span class="hljs-literal">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error writing to telnet!'</span>)
  )

  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'disconnect'</span>, <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'disconnect the telnet connection!\n'</span>)
    <span class="hljs-keyword">if</span> telnet?
      telnet.destroy()
      telnet = <span class="hljs-literal">null</span>
  )

  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'close the telnet connection!\n'</span>)
    <span class="hljs-keyword">if</span> telnet?
      telnet.destroy()
      telnet = <span class="hljs-literal">null</span>
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Used when the client requested an identifer based on the hash URLs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'req_markup'</span>, <span class="hljs-function"><span class="hljs-params">(ident)</span> =&gt;</span>
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'client requested hash URL '</span> + ident</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>ident is the identifer for the encore URL to return</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    url = <span class="hljs-string">"http://"</span> + server + <span class="hljs-string">":"</span> + enCore_port + <span class="hljs-string">"/"</span> + ident
    s.get_html(url, access_code, <span class="hljs-function"><span class="hljs-params">(html)</span> =&gt;</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">'sending '</span> + url + <span class="hljs-string">' html to client'</span>
      io.emit(<span class="hljs-string">'markup'</span>, html, ident)

      xpress = <span class="hljs-string">"http://"</span> + server + <span class="hljs-string">":"</span> + enCore_port + <span class="hljs-string">"/Xpress_client/menu.html"</span>
      s.get_html(xpress, access_code, <span class="hljs-function"><span class="hljs-params">(html)</span> =&gt;</span>
        io.emit(<span class="hljs-string">'xpress'</span>, html))
    )
  )</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Used when the client requests a URL based on what comes over telnet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io.<span class="hljs-literal">on</span>(<span class="hljs-string">'req_url'</span>, <span class="hljs-function"><span class="hljs-params">(url)</span> =&gt;</span>
    s.get_html(url, access_code, <span class="hljs-function"><span class="hljs-params">(html)</span> =&gt;</span>

      <span class="hljs-keyword">if</span> url.charAt(url.length - <span class="hljs-number">1</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">'/'</span>
        end = url.length - <span class="hljs-number">1</span>
      <span class="hljs-keyword">else</span>
        end = url.length

      start = url.indexOf(<span class="hljs-string">":"</span> + enCore_port) + enCore_port.length + <span class="hljs-number">2</span>
      ident = url.substring(start, end)

      io.emit(<span class="hljs-string">'markup'</span>, html, ident)

      xpress = <span class="hljs-string">"http://"</span> + server + <span class="hljs-string">":"</span> + enCore_port + <span class="hljs-string">"/Xpress_client/menu.html"</span>
      s.get_html(xpress, access_code, <span class="hljs-function"><span class="hljs-params">(html)</span> =&gt;</span>
        io.emit(<span class="hljs-string">'xpress'</span>, html)
      )
    )
  )

app.listen(<span class="hljs-number">80</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb(err) <span class="hljs-keyword">if</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Find out which user used sudo through the environment variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uid = parseInt(process.env.SUDO_UID)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Set our serverâ€™s uid to that user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  process.setuid uid <span class="hljs-keyword">if</span> uid
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"Server's UID is now "</span> + process.getuid()
)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
