<!DOCTYPE html>

<html>
<head>
  <title>Cakefile.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="Cakefile.html">
                  Cakefile.coffee
                </a>
              
                
                <a class="source" href="server.html">
                  server.coffee
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Cakefile.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Template and modified from <a href="https://github.com/socrata/soda-js/blob/master/Cakefile">https://github.com/socrata/soda-js/blob/master/Cakefile</a> ,
<a href="https://github.com/kgn/wheel.coffee/blob/master/Cakefile">https://github.com/kgn/wheel.coffee/blob/master/Cakefile</a> , and
<a href="https://github.com/twilson63/cakefile-template">https://github.com/twilson63/cakefile-template</a></p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The files to build. The first is the resulting directory for the .js files.
The second directory is the source .coffee files.
The third directory contains the generated docs from docoo.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>files = [
  <span class="hljs-string">'dist'</span>
  <span class="hljs-string">'src'</span>
  <span class="hljs-string">'docs'</span>
]</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Require libraries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
{<span class="hljs-built_in">print</span>} = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
{spawn, exec} = <span class="hljs-built_in">require</span> <span class="hljs-string">'child_process'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Throw an error if <code>which</code> is not installed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">try</span>
  which = <span class="hljs-built_in">require</span>(<span class="hljs-string">'which'</span>).sync
<span class="hljs-keyword">catch</span> err
  <span class="hljs-keyword">if</span> process.platform.match(<span class="hljs-regexp">/^win/</span>)?
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'WARNING: the which module is required for windows\ntry: npm install which'</span>
  which = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>ANSI Terminal Colors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>bold = <span class="hljs-string">'\x1b[0;1m'</span>
green = <span class="hljs-string">'\x1b[0;32m'</span>
reset = <span class="hljs-string">'\x1b[0m'</span>
red = <span class="hljs-string">'\x1b[0;31m'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Cakefile Tasks</p>
<h2 id="-docs-"><em>docs</em></h2>
<p>Generate Annotated Documentation</p>
<p><small>Usage</small></p>
<pre><code>cake docs
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>task <span class="hljs-string">'docs'</span>, <span class="hljs-string">'generate documentation'</span>, <span class="hljs-function">-&gt;</span> docco -&gt; log <span class="hljs-string">"Done"</span>, green</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="-build-"><em>build</em></h2>
<p>Builds Source</p>
<p><small>Usage</small></p>
<pre><code>cake build
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>task <span class="hljs-string">'build'</span>, <span class="hljs-string">'compile source'</span>, <span class="hljs-function">-&gt;</span> build -&gt; log <span class="hljs-string">"Done"</span>, green</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="-watch-"><em>watch</em></h2>
<p>Builds your source whenever it changes</p>
<p><small>Usage</small></p>
<pre><code>cake watch
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>task <span class="hljs-string">'watch'</span>, <span class="hljs-string">'compile and watch'</span>, <span class="hljs-function">-&gt;</span> build <span class="hljs-literal">true</span>, <span class="hljs-function">-&gt;</span> log <span class="hljs-string">"Watch Ended"</span>, green</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="-test-"><em>test</em></h2>
<p>Runs your test suite.</p>
<p><small>Usage</small></p>
<pre><code>cake test
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>task <span class="hljs-string">'test'</span>, <span class="hljs-string">'run tests'</span>, <span class="hljs-function">-&gt;</span> jasmine [ <span class="hljs-string">'spec/'</span> ], <span class="hljs-function">-&gt;</span> log <span class="hljs-string">"Done"</span>, green</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="-clean-"><em>clean</em></h2>
<p>Cleans up generated js and doc files</p>
<p><small>Usage</small></p>
<pre><code>cake clean
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>task <span class="hljs-string">'clean'</span>, <span class="hljs-string">'clean generated files'</span>, <span class="hljs-function">-&gt;</span> clean -&gt; log <span class="hljs-string">"Removed all files in dist, and src"</span>, green</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Internal Functions</p>
<h2 id="-walk-"><em>walk</em></h2>
<p><strong>given</strong> string as dir which represents a directory in relation to local directory
<strong>and</strong> callback as done in the form of (err, results)
<strong>then</strong> recurse through directory returning an array of files</p>
<p>Examples</p>
<pre><code class="lang-coffeescript">walk <span class="hljs-string">'src'</span>, <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log results
</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">walk</span> = <span class="hljs-params">(dir, done)</span> -&gt;</span>
  results = []
  fs.readdir dir, <span class="hljs-function"><span class="hljs-params">(err, list)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> done(err, []) <span class="hljs-keyword">if</span> err
    pending = list.length
    <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, results) <span class="hljs-keyword">unless</span> pending
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> list
      file = <span class="hljs-string">"<span class="hljs-subst">#{dir}</span>/<span class="hljs-subst">#{name}</span>"</span>
      <span class="hljs-keyword">try</span>
        stat = fs.statSync file
      <span class="hljs-keyword">catch</span> err
        stat = <span class="hljs-literal">null</span>
      <span class="hljs-keyword">if</span> stat?.isDirectory()
        walk file, <span class="hljs-function"><span class="hljs-params">(err, res)</span> -&gt;</span>
          results.push name <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> res
          done(<span class="hljs-literal">null</span>, results) <span class="hljs-keyword">unless</span> --pending
      <span class="hljs-keyword">else</span>
        results.push file
        done(<span class="hljs-literal">null</span>, results) <span class="hljs-keyword">unless</span> --pending</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="-log-"><em>log</em></h2>
<p><strong>given</strong> string as a message
<strong>and</strong> string as a color
<strong>and</strong> optional string as an explanation
<strong>then</strong> builds a statement and logs to console.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">log</span> = <span class="hljs-params">(message, color, explanation)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log color + message + reset + <span class="hljs-string">' '</span> + (explanation <span class="hljs-keyword">or</span> <span class="hljs-string">''</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="-launch-"><em>launch</em></h2>
<p><strong>given</strong> string as a cmd
<strong>and</strong> optional array and option flags
<strong>and</strong> optional callback
<strong>then</strong> spawn cmd with options
<strong>and</strong> inhereit will use parent’s stdios
<strong>and</strong> on child process exit emit callback if set and status is 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">launch</span> = <span class="hljs-params">(cmd, options=[], callback)</span> -&gt;</span>
  cmd = which(cmd) <span class="hljs-keyword">if</span> which
  app = spawn cmd, options,
    <span class="hljs-attribute">stdio</span>: <span class="hljs-string">"inherit"</span>
  app.<span class="hljs-literal">on</span> <span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-params">(status)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
      callback()
    <span class="hljs-keyword">else</span>
      process.exit(status)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="-build-"><em>build</em></h2>
<p><strong>given</strong> optional boolean as watch
<strong>and</strong> optional function as callback
<strong>then</strong> invoke launch passing coffee command
<strong>and</strong> defaulted options to compile src to dist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">build</span> = <span class="hljs-params">(watch, callback)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> watch <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    callback = watch
    watch = <span class="hljs-literal">false</span>

  options = [<span class="hljs-string">'-c'</span>, <span class="hljs-string">'-b'</span>, <span class="hljs-string">'-o'</span> ]
  options = options.concat files
  options.unshift <span class="hljs-string">'-w'</span> <span class="hljs-keyword">if</span> watch
  launch <span class="hljs-string">'coffee'</span>, options, callback</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="-unlinkifcoffeefile-"><em>unlinkIfCoffeeFile</em></h2>
<p><strong>given</strong> string as file
<strong>and</strong> file ends in ‘.coffee’
<strong>then</strong> convert ‘.coffee’ to ‘.js’
<strong>and</strong> remove the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">unlinkIfCoffeeFile</span> = <span class="hljs-params">(file)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> file.match <span class="hljs-regexp">/\.coffee$/</span>
    fs.unlink file.replace(<span class="hljs-regexp">/\.coffee$/</span>, <span class="hljs-string">'.js'</span>), <span class="hljs-function">-&gt;</span>
    <span class="hljs-literal">true</span>
  <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="-unlinkifnotcoffeefile-"><em>unlinkIfNotCoffeeFile</em></h2>
<p><strong>given</strong> string as file
<strong>and</strong> file does not end in ‘.coffee’
<strong>then</strong> remove the result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">unlinkIfNotCoffeeFile</span> = <span class="hljs-params">(file)</span> -&gt;</span>
  <span class="hljs-keyword">unless</span> file.match <span class="hljs-regexp">/\.coffee$/</span>
    fs.unlink file, <span class="hljs-function">-&gt;</span>
    <span class="hljs-literal">true</span>
  <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="-clean-"><em>clean</em></h2>
<p><strong>given</strong> optional function as callback
<strong>then</strong> loop through files variable
<strong>and</strong> call unlinkIfCoffeeFile on each</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">clean</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files
      <span class="hljs-keyword">unless</span> unlinkIfCoffeeFile file
        walk file, <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span>
          <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> results
            unlinkIfNotCoffeeFile f

    callback?()
  <span class="hljs-keyword">catch</span> err</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="-moduleexists-"><em>moduleExists</em></h2>
<p><strong>given</strong> name for module
<strong>when</strong> trying to require module
<strong>and</strong> not found
<strong>then</strong> print not found message with install helper in red
<strong>and</strong> return false if not found</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">moduleExists</span> = <span class="hljs-params">(name)</span> -&gt;</span>
  <span class="hljs-keyword">try</span>
    <span class="hljs-built_in">require</span> name
  <span class="hljs-keyword">catch</span> err
    log <span class="hljs-string">"<span class="hljs-subst">#{name}</span> required: npm install <span class="hljs-subst">#{name}</span>"</span>, red
    <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h2 id="-jasmine-"><em>jasmine</em></h2>
<p><strong>given</strong> optional array of option flags
<strong>and</strong> optional function as callback
<strong>then</strong> invoke launch passing jasmine-node command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">jasmine</span> = <span class="hljs-params">(options, callback)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
    callback = options
    options = []
  options.push <span class="hljs-string">'--verbose'</span>
  options.push <span class="hljs-string">'--forceexit'</span>
  options.push <span class="hljs-string">'--coffee'</span>
  options.reverse()

  launch <span class="hljs-string">'jasmine-node'</span>, options, callback</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h2 id="-docco-"><em>docco</em></h2>
<p><strong>given</strong> optional function as callback
<strong>then</strong> invoke launch passing docco command</p>
<p><strong>NOTE:</strong>
docco only builds docs for .coffee files, so make a copy of Cakefile as Cakefile.coffee,
then after the docs are made, delete (unlink) Cakefile.coffee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">docco</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
  fs.readFile(<span class="hljs-string">'Cakefile'</span>, <span class="hljs-string">'utf8'</span>, <span class="hljs-function"><span class="hljs-params">(readerr, text)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> readerr <span class="hljs-keyword">if</span> readerr
    fs.writeFile(<span class="hljs-string">'src/Cakefile.coffee'</span>, text, <span class="hljs-function"><span class="hljs-params">(writeerr)</span> -&gt;</span>
      <span class="hljs-keyword">throw</span> writeerr <span class="hljs-keyword">if</span> writeerr
      walk <span class="hljs-string">"src"</span>, <span class="hljs-function"><span class="hljs-params">(err, files)</span> -&gt;</span>
        launch <span class="hljs-string">"./node_modules/docco/bin/docco"</span>, files, <span class="hljs-function">-&gt;</span>
          fs.unlink <span class="hljs-string">"src/Cakefile.coffee"</span>
          callback()
     )
  )</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
