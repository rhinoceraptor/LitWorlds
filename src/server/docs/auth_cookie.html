<!DOCTYPE html>

<html>
<head>
  <title>auth_cookie.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Cakefile.html">
                Cakefile.coffee
              </a>
            
              
              <a class="source" href="auth_cookie.html">
                auth_cookie.coffee
              </a>
            
              
              <a class="source" href="scrape.html">
                scrape.coffee
              </a>
            
              
              <a class="source" href="server.html">
                server.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>auth_cookie.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>auth_cookie.coffee</p>
<p>cookie is a class used to store each user session’s cooke tokenn for use by
enCore in keeping text and graphical modes in sync.</p>
<p>We first make a POST back to enCore with some form data: “useridField” and
“passwordField”. These values will come from the frontend login form, if they
are “” and “”, we will use the default value of “Guest” and “”.</p>
<h6 id="-">#</h6>

            </div>
            
            <div class="content"><div class='highlight'><pre>request = <span class="hljs-built_in">require</span> <span class="hljs-string">'request'</span>
formstream = <span class="hljs-built_in">require</span> <span class="hljs-string">'formstream'</span>
http = <span class="hljs-built_in">require</span> <span class="hljs-string">'http'</span>
cheerio = <span class="hljs-built_in">require</span> <span class="hljs-string">'cheerio'</span>
jsdom = <span class="hljs-built_in">require</span> <span class="hljs-string">'jsdom'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">auth_cookie</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(server, port)</span> -&gt;</span>
    <span class="hljs-property">@server</span> = server
    <span class="hljs-property">@port</span> = port</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Get an HTTP enCore access code using the user and passwd given</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get_access_code</span>: <span class="hljs-function"><span class="hljs-params">(user, passwd, callback)</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Create the form to POST</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    form = formstream()
    form.field(<span class="hljs-string">'useridField'</span>, user)
    .field(<span class="hljs-string">'passwordField'</span>, passwd)
    .field(<span class="hljs-string">'xpress'</span>, <span class="hljs-string">'Log in'</span>)

    options = {
      <span class="hljs-attribute">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attribute">host</span>: <span class="hljs-property">@server</span>,
      <span class="hljs-attribute">port</span>: <span class="hljs-property">@port</span>,
      <span class="hljs-attribute">path</span>: <span class="hljs-string">'/'</span>,
      <span class="hljs-attribute">headers</span>: form.headers()
    }

    req = http.request(options, <span class="hljs-function"><span class="hljs-params">(res)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> res.headers[<span class="hljs-string">'set-cookie'</span>]
        callback(res.headers[<span class="hljs-string">'set-cookie'</span>][<span class="hljs-number">0</span>])
      <span class="hljs-keyword">else</span>
        callback(<span class="hljs-string">"failed"</span>)
    )
    form.pipe(req);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Get an autologin string for telnet using the enCore access code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">get_autologin_string</span>: <span class="hljs-function"><span class="hljs-params">(access_code, callback)</span> =&gt;</span>
    url = <span class="hljs-string">"http://"</span> + <span class="hljs-property">@server</span> + <span class="hljs-string">":"</span> + <span class="hljs-property">@port</span> + <span class="hljs-string">"/Xpress_client/java.html"</span>

    options = {
      <span class="hljs-attribute">method</span>: <span class="hljs-string">'GET'</span>,
      <span class="hljs-attribute">url</span>: url,
      <span class="hljs-attribute">headers</span>: {<span class="hljs-string">'Cookie: '</span>: access_code}
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Make a GET request to enCore using the access code given as a cookie</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    request(options, <span class="hljs-function"><span class="hljs-params">(err, res, body)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> !err <span class="hljs-keyword">and</span> res.statusCode <span class="hljs-keyword">is</span> <span class="hljs-number">200</span>
        <span class="hljs-built_in">document</span> = jsdom.jsdom(body)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">document</span>.location._window.<span class="hljs-built_in">window</span>._java_client_param_pairs
          login = <span class="hljs-built_in">document</span>.location._window.<span class="hljs-built_in">window</span>._java_client_param_pairs[<span class="hljs-number">6</span>][<span class="hljs-number">1</span>]
          callback(login)
        <span class="hljs-keyword">else</span>
          callback(<span class="hljs-string">'failed'</span>)
      <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">console</span>.log err
    )

<span class="hljs-built_in">module</span>.exports = auth_cookie</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
