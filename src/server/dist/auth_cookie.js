// Generated by CoffeeScript 1.7.1
var auth_cookie, cheerio, formstream, http, jsdom, request,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

request = require('request');

formstream = require('formstream');

http = require('http');

cheerio = require('cheerio');

jsdom = require('jsdom');

auth_cookie = (function() {
  function auth_cookie(server, port) {
    this.get_autologin_string = __bind(this.get_autologin_string, this);
    this.get_access_code = __bind(this.get_access_code, this);
    this.server = server;
    this.port = port;
  }

  auth_cookie.prototype.get_access_code = function(user, passwd, callback) {
    var form, options, req;
    form = formstream();
    form.field('useridField', user).field('passwordField', passwd).field('xpress', 'Log in');
    options = {
      method: 'POST',
      host: this.server,
      port: this.port,
      path: '/',
      headers: form.headers()
    };
    req = http.request(options, function(res) {
      if (res.headers['set-cookie']) {
        return callback(res.headers['set-cookie'][0]);
      } else {
        return callback("failed");
      }
    });
    return form.pipe(req);
  };

  auth_cookie.prototype.get_autologin_string = function(access_code, callback) {
    var options, url;
    url = "http://" + this.server + ":" + this.port + "/Xpress_client/java.html";
    options = {
      method: 'GET',
      url: url,
      headers: {
        'Cookie: ': access_code
      }
    };
    return request(options, (function(_this) {
      return function(err, res, body) {
        var document, login;
        if (!err && res.statusCode === 200) {
          document = jsdom.jsdom(body);
          if (document.location._window.window._java_client_param_pairs) {
            login = document.location._window.window._java_client_param_pairs[6][1];
            return callback(login);
          } else {
            return callback('failed!');
          }
        } else {
          return console.log(err);
        }
      };
    })(this));
  };

  return auth_cookie;

})();

module.exports = auth_cookie;
